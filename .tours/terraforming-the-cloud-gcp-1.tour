{
  "$schema": "https://aka.ms/codetour-schema",
  "title": "terraforming-the-cloud-gcp-1",
  "steps": [
    {
      "file": "tutorial.md",
      "description": "Bem-vindo ao workshop!\n\nAqui tens um breve resumo dos conteÃºdos abordados neste mÃ³dulo.\n\nAproveita para dar uma vista de olhos nos tÃ³picos e verificar se tens todos os requisitos para prosseguir com o workshop.",
      "line": 2
    },
    {
      "file": "tutorial.md",
      "description": "Certifica-te que estÃ¡s no teu terminal fazendo o comando:\n- **ctrl+Ã§**\n\nAlternativamente, no canto superior esquerdo, podes tambÃ©m clicar em:\n\n- **View** e depois selecionar **Terminal**",
      "line": 5
    },
    {
      "file": "tutorial.md",
      "description": "No terminal faz login em GCP utilizando o comando:\n>> gcloud auth login --update-adc --no-launch-browser",
      "line": 6
    },
    {
      "file": "tutorial.md",
      "description": "Para definir o projecto faz o comando:\n>> gcloud config set project ten21-wshop01-p-154457 && gcloud config set accessibility/screen_reader false\n\nCertifica-te que estÃ¡s no projecto correcto fazendo o comando:\n>> gcloud config get-value project\n\n\nSe quiseres ver todos os projectos a que tens acesso faz o comando:\n>> gcloud projects list",
      "line": 7
    },
    {
      "file": "terraform.tfvars",
      "selection": {
        "start": {
          "line": 1,
          "character": 1
        },
        "end": {
          "line": 1,
          "character": 17
        }
      },
      "description": "Para evitar que o terraform peÃ§a o nome do projeto a cada apply, podemos definir o nome do projeto por defeito:\n\n- Descomenta a linha **project_id** e adiciona o id do projecto.\n\nPara descomentar seleciona o bloco e faz o comando:\n\n- Windows: **CTRL + K + U**\n- Mac: **CMD + K + U**"
    },
    {
      "file": "main.tf",
      "description": "## 1. O primeiro contacto\n\nNesta secÃ§Ã£o iremos executar os 4 principais comandos de terraform: init, plan, apply e destroy.\n\n**[terraform init](https://developer.hashicorp.com/terraform/cli/commands/init)**\n- O comando terraform init Ã© utilizado para inicializar uma diretoria que contÃ©m ficheiros de configuraÃ§Ã£o de Terraform. Este Ã© o primeiro comando que deve ser executado apÃ³s escrever uma nova configuraÃ§Ã£o de Terraform ou clonar uma existente. Ã‰ seguro executar este comando vÃ¡rias vezes.",
      "line": 1
    },
    {
      "file": "main.tf",
      "description": "Para comeÃ§ar executa o comando:\n\n>> terraform init",
      "line": 2
    },
    {
      "file": "main.tf",
      "description": "**[terraform plan](https://developer.hashicorp.com/terraform/cli/commands/plan)**\n\nO comando terraform plan cria um plano de execuÃ§Ã£o, permitindo visualizar antecipadamente as alteraÃ§Ãµes que o Terraform pretende fazer Ã  infraestrutura. Por predefiniÃ§Ã£o, quando o Terraform cria um plan:\n\n- LÃª o estado atual de quaisquer objetos remotos existentes para garantir que o estado do Terraform estÃ¡ atualizado.\n- Compara a configuraÃ§Ã£o atual com o estado anterior e regista quaisquer diferenÃ§as.\n- PropÃµe um conjunto de aÃ§Ãµes que, se aplicadas, farÃ£o com que os objetos remotos correspondam Ã  configuraÃ§Ã£o.",
      "line": 3
    },
    {
      "file": "main.tf",
      "description": "Para veres as alteraÃ§Ãµes a serem feitas Ã  tua infraestrutura executa o comando:\n\n>> terraform plan -out plan.tfplan",
      "line": 4
    },
    {
      "file": "main.tf",
      "description": "**[terraform apply](https://developer.hashicorp.com/terraform/cli/commands/apply)**\n\n- O comando terraform apply executa as aÃ§Ãµes propostas num plan de Terraform.",
      "line": 5
    },
    {
      "file": "main.tf",
      "description": "Para aplicares as alteraÃ§Ãµes executa o comando:\n\n>> terraform apply plan.tfplan\n\nâ—NÃ£o te esqueÃ§as de escrever **yes** para confirmar o apply.\n\nâ³ Tempo do apply - 1 min.\n\nVerifica que o recurso remoto foi criado:\n>> gcloud compute instances list --filter=\"name=$(terraform output -raw vm_name)\" --format=\"table(name, zone, status, machineType)\"\n\n\nVerifica todas as compute instances criadas:\n>> gcloud compute instances list",
      "line": 6,
      "selection": {
        "start": {
          "line": 10,
          "character": 1
        },
        "end": {
          "line": 11,
          "character": 1
        }
      }
    },
    {
      "file": "main.tf",
      "description": "**[terraform destroy](https://developer.hashicorp.com/terraform/cli/commands/destroy)**\n\n- O comando terraform destroy Ã© uma forma prÃ¡tica de destruir todos os objetos geridos por uma determinada configuraÃ§Ã£o de Terraform.\n\nEmbora normalmente nÃ£o se queira destruir objetos num ambiente de produÃ§Ã£o, o Terraform Ã©, por vezes, utilizado para gerir infraestrutura efÃ©mera para fins de desenvolvimento. Nesse caso, podemos utilizar o terraform destroy para apagar todos estes recursos.",
      "line": 7
    },
    {
      "file": "main.tf",
      "description": "Vamos destruir os recursos, para tal executa o comando:\n\n>> terraform destroy\n\nâ³ Tempo do destroy - 2 min.",
      "line": 8
    },
    {
      "file": "main.tf",
      "description": "Confirma a destruiÃ§Ã£o dos recursos:\n>> gcloud compute instances list --filter=\"name=$(terraform output -raw my_identifier)-vm\" --format=\"table(name, zone, status, machineType)\"\n\n\nCaso queiras verificar o estado das restantes compute instances:\n>> gcloud compute instances list\n\nNÃ£o deverÃ¡ apresentar resultados porque estes recursos foram destruÃ­dos.",
      "line": 9
    },
    {
      "file": "main.tf",
      "description": "## 2. lidar com as alteraÃ§Ãµes\n\nNesta secÃ§Ã£o iremos demonstrar a utilizaÃ§Ã£o de terraform perante varios tipos de alteraÃ§Ãµes.\n\nAssegurar a recriaÃ§Ã£o dos recursos.\n\nPlan:\n>> terraform plan -out plan.tfplan\n\nApply:\n>> terraform apply plan.tfplan\n\nâ° Tempo mÃ©dio do apply - 1 min.",
      "line": 16
    },
    {
      "file": "main.tf",
      "description": "**Tentar entrar para a mÃ¡quina via SSH**\n\nPodem obter o comando a partir do output do terraform, ou usando o comando gcloud:\n>> gcloud compute ssh $(terraform output -raw vm_name) --project=$(terraform output -raw project_id) --zone $(terraform output -raw vm_zone)\n\nNÃ£o deverÃ¡ ser possÃ­vel fazer ssh porque precisamos de introduzir uma *firewall-tag* vamos entÃ£o efectuar uma alteraÃ§Ã£o **nÃ£o-disruptiva**.",
      "line": 53
    },
    {
      "file": "main.tf",
      "selection": {
        "start": {
          "line": 57,
          "character": 1
        },
        "end": {
          "line": 58,
          "character": 26
        }
      },
      "description": "## 2.1 Introduzindo alteraÃ§Ãµes nÃ£o-disruptivas\n\nAs alteraÃ§Ãµes nÃ£o disruptivas sÃ£o pequenas alteraÃ§Ãµes que possibilitam a re-configuraÃ§Ã£o do recurso sem que este tenha que ser recriado, nÃ£o afetando as suas dependÃªncias.\n\n- Editar o ficheiro **main.tf**, localizar o recurso *google_compute_instance.default* e descomentar o campo **tags = [ \"allow-iap\" ]** na definiÃ§Ã£o do recurso.\n\nUtiliza o comando:\n\nWindows: **CTRL + K + U**\n\nMac: **CMD + K + U**"
    },
    {
      "file": "main.tf",
      "description": "Executar **terraform plan -out plan.tfplan** e verificar que o Terraform irÃ¡ efectuar um update in-place - isto Ã© uma alteraÃ§Ã£o simples.\n\n>> terraform plan -out plan.tfplan\n\nExecutar **terraform apply plan.tfplan.**\n\n>> terraform apply plan.tfplan\n\nâ° Tempo mÃ©dio do apply - 1 min.",
      "line": 59
    },
    {
      "file": "main.tf",
      "description": "Como adicionÃ¡mos uma tag que permite indicar Ã  firewall o acesso SSH por IAP, podemos entÃ£o testar novo comando de SSH:\n>> gcloud compute ssh $(terraform output -raw vm_name) --project=$(terraform output -raw project_id) --zone $(terraform output -raw vm_zone)",
      "line": 59
    },
    {
      "file": "main.tf",
      "selection": {
        "start": {
          "line": 54,
          "character": 3
        },
        "end": {
          "line": 54,
          "character": 44
        }
      },
      "description": "## 2.2 Introduzindo alteraÃ§Ãµes disruptivas\n\nAs alteraÃ§Ãµes disruptivas sÃ£o provocadas por alteraÃ§Ãµes de propriedades que provocam a recriaÃ§Ã£o do recurso e consequentes dependencias.\n\nNo ficheiro **main.tf**, localiza o recurso *google_compute_instance.default* e altera o campo name para o seguinte: **\"${random_pet.this.id}-vm-new\"**"
    },
    {
      "file": "main.tf",
      "description": "Executar **terraform plan -out plan.tfplan** e verificar que o Terraform irÃ¡ efectuar um replacement - Ã© uma **alteraÃ§Ã£o disruptiva**.\n\n>> terraform plan -out plan.tfplan\n\nAplicar o plan, verificar e acompanhar observando na execuÃ§Ã£o do terraform que irÃ¡ acontecer um **destroy** seguido de um **create**:\n\n>> terraform apply plan.tfplan\n\nâ° Tempo mÃ©dio do apply - 3 min.",
      "line": 55
    },
    {
      "file": "main.tf",
      "description": "Verificar que o SSH continua a ser possÃ­vel, mesmo com a nova instÃ¢ncia:\n\n*o comando pode nÃ£o funcionar logo...pode demorar atÃ© 1 minuto depois da VM ser criada.*\n\n>> gcloud compute ssh $(terraform output -raw vm_name) --project=$(terraform output -raw project_id) --zone $(terraform output -raw vm_zone)",
      "line": 70
    },
    {
      "file": "terraform.tfvars",
      "selection": {
        "start": {
          "line": 2,
          "character": 1
        },
        "end": {
          "line": 2,
          "character": 15
        }
      },
      "description": "## 2.3 Introduzindo alteraÃ§Ãµes dependentes\n\nAs alteraÃ§Ãµes tambÃ©m podem ser derivadas de dependÃªndencias, e quando isso acontece, todo o grafo de dependendencias Ã© afetado.\n\nEditar o ficheiro **terraform.tfvars** e alterar o valor da variavel prefix de **gcp** para **new**"
    },
    {
      "file": "terraform.tfvars",
      "description": "Executar o plan e verificar todo o grafo de dependencias Ã© afetado:\n\n>> terraform plan -out plan.tfplan\n\nExecutar o apply:\n\n>> terraform apply plan.tfplan\n\nâ° Tempo mÃ©dio do apply - 3 min.\n\n*Notem que apenas alterÃ¡mos uma mera variÃ¡vel...*\n\n**NOTA: NÃƒO DESTRUIR OS RECURSOS pois vamos usa-los no prÃ³ximo passo**",
      "line": 3
    },
    {
      "file": "import-exercise.tf",
      "description": "## 3. Importar recursos jÃ¡ existentes\n\nTerraform Import possibilita colocar infraestrutura jÃ¡ existente sob a tua gestÃ£o. Ao importar recursos para o terraform, podes gerir a tua infraestrutura de maneira coerente e consistente utilizando um fluxo de trabalho comum.\n\nEsta Ã© uma boa maneira de se fazer uma transiÃ§Ã£o gradual da infraestrutura para o terraform, ou de garantir que no futuro podemos utilizar o terraform, mesmo que actualmente ele nÃ£o tenha todas as capacidades que desejarÃ­amos.",
      "line": 1
    },
    {
      "file": "import-exercise.tf",
      "description": "Assegurar que nÃ£o existem alteraÃ§Ãµes pendentes:\n\nPlan:\n>> terraform plan -out plan.tfplan\n\nApply\n>> terraform apply plan.tfplan",
      "line": 2
    },
    {
      "file": "import-exercise.tf",
      "description": "## 3.1 Criar um recurso (google_compute_network) usando os comandos gcloud\nNesta parte vamos criar recursos recorrendo a uma ferramenta externa ao terraform por forma a criar um use-case de recursos que existem fora do state do terraform.\n\nO objetivo Ã© simular recursos que jÃ¡ existiam para que os possamos terraformar.\n\nCriar uma vpc:\n\n>> gcloud compute networks create $(terraform output -raw my_identifier)-vpc --project=$(terraform output -raw project_id) --subnet-mode=custom",
      "line": 3
    },
    {
      "file": "import-exercise.tf",
      "description": "## 3.2 Importar recursos existentes\nO processo de importaÃ§Ã£o de recursos consiste em duas partes:\n\nObtenÃ§Ã£o da informaÃ§Ã£o do recurso na cloud\nCriaÃ§Ã£o de um bloco import que irÃ¡ indicar ao terraform que o recurso jÃ¡ existe e que o mesmo deve ser gerido pelo terraform.\n\nO primeiro passo da importaÃ§Ã£o de recursos Ã© declarar a importaÃ§Ã£o dos mesmos.\n\nPara isto, temos que definir o bloco import, que necessita de dois argumentos:\n- id: o id do recurso a importar do lado do GCP\n\n- to: o identificador terraform do recurso a importar",
      "line": 4
    },
    {
      "file": "import-exercise.tf",
      "description": "Para o exercicio que segue, vamos ao ficheiro **import-exercise.tf** e descomentar os blocos import { ... }\n\nUtiliza o comando:\n\n**Windows: CTRL + K + U**\n\n**Mac: CMD + K + U**\n\nAntes de efetuar a importaÃ§Ã£o precisamos de obter o id do recurso a importar do lado do GCP tal como descrito nas instruÃ§Ãµes de importaÃ§Ã£o para o recurso google_compute_network.\n\nExistem vÃ¡rias formas para obter o id dos recursos, neste exemplo usamos os comandos gcloud:\n\nObter o id para a google_compute_network:\n\n>> gcloud compute networks list --uri | grep \"$(terraform output -raw my_identifier)\" | sed \"s~https://www.googleapis.com/compute/v1/~~\"",
      "line": 5
    },
    {
      "file": "import-exercise.tf",
      "selection": {
        "start": {
          "line": 2,
          "character": 1
        },
        "end": {
          "line": 5,
          "character": 4
        }
      },
      "description": "Agora que temos o identificador dos recursos, temos que preencher o respetivo **id** no bloco import:\n\nSubstituir o id do recurso *google_compute_network* no bloco import do ficheiro **import-exercise.tf**\n\nVamos entÃ£o correr o plan, mas vamos usar a opÃ§Ã£o -generate-config-out para gerar o cÃ³digo dos recursos que vÃ£o ser importados para o ficheiro **imported-resources.tf**:\n\n>> terraform plan -out plan.tfplan -generate-config-out imported-resources.tf\n\nPodemos inspeccionar os conteudos do ficheiro **imported-resources.tf**.\n\nPor fim, o apply para executar a operaÃ§Ã£o planeada:\n\n>> terraform apply plan.tfplan"
    },
    {
      "file": "import-exercise.tf",
      "description": "Agora, se tentarmos agora fazer plan novamente, vamos verificar que o terraform indica que nÃ£o tem alteraÃ§Ãµes Ã  infraestrutura, confirmando que os recursos foram importados som sucesso.\n\nTestar o plan:\n\n>> terraform plan -out plan.tfplan",
      "line": 6
    },
    {
      "file": "final-exercise.tf",
      "description": "## 4. ExercÃ­cio\nNeste exercicio o objectivo Ã© aplicar alguns dos conhecimentos adquiridos nesta sessÃ£o sem que exista uma soluÃ§Ã£o pronta para descomentarem ğŸ˜‰.\n\nPrentende-se o seguinte:\n\nğŸ‘‰ Devem fazer o exercicio no ficheiro final-exercise.tf.\n\nğŸ‘‰ Criar uma Google Cloud Service Account com os seguintes requisitos:\n\naccount_id deverÃ¡ ser prefixada com valor definido no recurso random_pet.this.id para evitar colisÃµes de nomes\n\nğŸ‘‰ Criar uma Google Cloud Compute Instance com os seguintes requisitos:\n\nNome da mÃ¡quina deverÃ¡ ser prefixado com valor definido no recurso random_pet.this.id para evitar colisÃµes de nomes\n\nTipo de mÃ¡quina: e2-micro\n\nZona: europe-west1-b\n\nDeverÃ¡ conter uma tag allow-iap\n\nA rede (subnetwork) onde a VM vai correr fica ao vosso critÃ©rio: podem criar uma nova, ou podem usar as jÃ¡ existentes.\n\nA mÃ¡quina deverÃ¡ correr com a google_service_account previamente criada.\n\nğŸ‘‰ Por fim, deverÃ£o testar o correto aprovisionamento fazendo ssh para a mÃ¡quina que acabaram de criar.",
      "line": 1
    },
    {
      "file": "final-exercise.tf",
      "description": "AjudasğŸ˜µ\nğŸ’¡ Usem a pesquisa no terraform registry / google para saberem mais informaÃ§Ã£o acerca dos recursos que estÃ£o a usar:\n\n[google_service_account](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/google_service_account)\n\n[google_compute_instance](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_instance)\n\nPara fazeres ssh faz o seguinte comando:\n\n**gcloud compute ssh <COMPUTE_INSTANCE_NAME> --project <PROJECT-ID> --zone <ZONE-NAME>**\n\nğŸ’¡Preenche os campos necessÃ¡rios com a informaÃ§Ã£o referente Ã  tua Compute Instance Name, Project ID e Zone\n\nğŸ’¡ Uma subnet jÃ¡ existente poderÃ¡ ser *data.google_compute_subnetwork.default.self_link.*\n\nğŸ’¡ Caso nÃ£o consigam fazer ssh, tambÃ©m podem consultar a descriÃ§Ã£o da VM recorrendo ao comando:\n\n**gcloud compute instances describe COMPUTE_INSTANCE_NAME --zone=COMPUTE_INSTANCE_ZONE**",
      "line": 2
    },
    {
      "file": "main.tf",
      "description": "## 5. wrap-up & destroy\nDestruir os conteÃºdos!\n\n>> terraform destroy\n\nğŸ”šğŸ ChegÃ¡mos ao fim ğŸğŸ”š",
      "line": 51
    }
  ],
  "ref": "main"
}